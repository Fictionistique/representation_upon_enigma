{% extends "base.html" %}

{% block title %}{{ bill.title }} - Forum{% endblock %}

{% block content %}
<div class="main-layout">
    <div class="search-section">
        <!-- Search Container -->
        <div class="search-container">
            <form hx-get="/api/search" 
                  hx-target="#search-suggestions"
                  hx-indicator="#search-loading"
                  class="search-form">
                <input 
                    type="text" 
                    class="search-input" 
                    placeholder="Search legislative bills..." 
                    name="query"
                    id="search-query"
                />
                <button type="submit" class="search-btn">Search</button>
            </form>
            <div id="search-loading" class="loading-bar htmx-indicator">
                <div class="loading-bar-progress"></div>
            </div>
            <div id="search-suggestions" class="search-suggestions" style="display: none;"></div>
        </div>

        <!-- Forum Section -->
        <div id="forum-section" class="forum-section">
            {% include "forum.html" %}
        </div>
    </div>

    <!-- Recent Bills Sidebar -->
    <aside class="recent-bills">
        <!-- For MPs Button -->
        <button class="mp-dashboard-btn" onclick="openMPModal()">
            For MPs
        </button>
        
        <h2>Recent Bills</h2>
        <div id="bills-container" hx-get="/api/bills?page=1" hx-trigger="load" hx-swap="innerHTML">
            <!-- Bills will be loaded here -->
        </div>
    </aside>
</div>

<!-- MP Dashboard Modal -->
<div id="mp-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeMPModal()">&times;</span>
        <h2 class="modal-title">MP Constituency Dashboard</h2>
        <p class="modal-subtitle">Generate a comprehensive report of constituent sentiment</p>
        
        <form id="mp-form" action="/api/mp/report" method="GET" target="_blank">
            <div class="form-group">
                <label for="mp-constituency" class="form-label">Select Your Constituency</label>
                <select id="mp-constituency" name="constituency_id" class="form-input" required>
                    <option value="">Choose constituency...</option>
                </select>
            </div>
            
            <button type="submit" class="submit-btn">Generate PDF Report</button>
        </form>
    </div>
</div>

<script>
    function selectSuggestion(billId) {
        // Hide suggestions
        document.getElementById('search-suggestions').style.display = 'none';
        
        // Navigate to forum page
        window.location.href = '/f/' + billId;
    }

    // Show suggestions when they load
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'search-suggestions') {
            const suggestions = event.detail.target;
            if (suggestions.children.length > 0) {
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }
    });

    // MP Modal functions
    function openMPModal() {
        const modal = document.getElementById('mp-modal');
        modal.style.display = 'flex';
        
        // Load constituencies if not already loaded
        const select = document.getElementById('mp-constituency');
        if (select.options.length === 1) {
            fetch('/api/constituencies')
                .then(res => res.json())
                .then(constituencies => {
                    constituencies.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = `${c.name} (${c.state})`;
                        select.appendChild(option);
                    });
                });
        }
    }

    function closeMPModal() {
        document.getElementById('mp-modal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('mp-modal');
        if (event.target === modal) {
            closeMPModal();
        }
    }
</script>
{% endblock %}

