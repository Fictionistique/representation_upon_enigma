{% extends "base.html" %}

{% block title %}{{ profile.username }} - Profile{% endblock %}

{% block content %}
<main class="profile-container">
    <div class="profile-header">
        <div class="profile-info">
            <div class="profile-avatar">
                {{ profile.username.chars().next().unwrap_or('U').to_ascii_uppercase() }}
            </div>
            <div class="profile-details">
                <h2 class="profile-username">{{ profile.username }}</h2>
                {% if let Some(name) = profile.real_name.as_ref() %}
                <p class="profile-realname">{{ name }}</p>
                {% endif %}
                <div class="profile-meta">
                    {% if let Some(constituency) = profile.constituency_name.as_ref() %}
                    <span class="meta-item">üìç {{ constituency }}</span>
                    {% endif %}
                    <span class="meta-item">üìÖ Member since {{ profile.member_since }}</span>
                    <span class="meta-item">üí¨ {{ profile.post_count }} posts</span>
                </div>
            </div>
        </div>
    </div>

    {% if is_own_profile %}
    <div class="profile-edit-section">
        <h3 class="section-title">Edit Profile</h3>
        <form method="POST" action="/u/{{ profile.username }}" class="profile-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="real_name" class="form-label">Real Name</label>
                    <input 
                        type="text" 
                        id="real_name" 
                        name="real_name" 
                        class="form-input"
                        value="{% if let Some(n) = profile.real_name.as_ref() %}{{ n }}{% endif %}"
                    >
                </div>

                <div class="form-group">
                    <label for="age" class="form-label">Age</label>
                    <input 
                        type="number" 
                        id="age" 
                        name="age" 
                        class="form-input"
                        min="18"
                        max="120"
                        value="{% if let Some(a) = profile.age %}{{ a }}{% endif %}"
                    >
                </div>

                <div class="form-group">
                    <label for="gender" class="form-label">Gender</label>
                    <select id="gender" name="gender" class="form-input">
                        <option value="">Select...</option>
                        <option value="Male" {% if profile.gender.as_deref() == Some("Male") %}selected{% endif %}>Male</option>
                        <option value="Female" {% if profile.gender.as_deref() == Some("Female") %}selected{% endif %}>Female</option>
                        <option value="Other" {% if profile.gender.as_deref() == Some("Other") %}selected{% endif %}>Other</option>
                        <option value="Prefer not to say" {% if profile.gender.as_deref() == Some("Prefer not to say") %}selected{% endif %}>Prefer not to say</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h4 class="form-section-title">Location</h4>
                <div class="location-toggle">
                    <input type="radio" id="loc_pincode" name="location_type" value="pincode" {% if profile.pincode.is_some() || profile.constituency_id == 0 %}checked{% endif %}>
                    <label for="loc_pincode" class="toggle-label">By Pincode</label>
                    
                    <input type="radio" id="loc_constituency" name="location_type" value="constituency" {% if profile.constituency_id != 0 && profile.pincode.is_none() %}checked{% endif %}>
                    <label for="loc_constituency" class="toggle-label">By Constituency</label>
                </div>

                <div id="pincode-section" class="location-section {% if profile.constituency_id != 0 && profile.pincode.is_none() %}hidden{% endif %}">
                    <div class="form-group">
                        <label for="pincode" class="form-label">Pincode</label>
                        <input 
                            type="text" 
                            id="pincode" 
                            name="pincode" 
                            class="form-input"
                            pattern="[0-9]{6}"
                            maxlength="6"
                            value="{% if let Some(p) = profile.pincode.as_ref() %}{{ p }}{% endif %}"
                        >
                    </div>
                </div>

                <div id="constituency-section" class="location-section {% if profile.pincode.is_some() || profile.constituency_id == 0 %}hidden{% endif %}">
                    <div class="form-group">
                        <label for="constituency_id" class="form-label">Constituency</label>
                        <select id="constituency_id" name="constituency_id" class="form-input">
                            <option value="">Select your constituency...</option>
                            {% for c in constituencies %}
                            <option value="{{ c.id }}" {% if profile.constituency_id == c.id %}selected{% endif %}>{{ c.name }} ({{ c.state }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <button type="submit" class="profile-save-btn">Save Changes</button>
        </form>
    </div>
    {% endif %}

    <div class="profile-posts-section">
        <h3 class="section-title">
            {% if is_own_profile %}Your Posts{% else %}{{ profile.username }}'s Posts{% endif %}
        </h3>

        {% if posts.is_empty() %}
        <div class="empty-posts">
            <p>No posts yet.</p>
            {% if is_own_profile %}
            <p>Head to a bill's forum to share your thoughts!</p>
            {% endif %}
        </div>
        {% else %}
        <div class="posts-list">
            {% for post in posts %}
            <div class="post-card">
                <div class="post-header">
                    <div class="post-bill">
                        <span class="bill-title">{{ post.bill_title }}</span>
                        <span class="bill-number">Bill No. {{ post.bill_number }}</span>
                    </div>
                    <div class="post-meta">
                        <span class="post-stance stance-{{ post.stance|lower }}">{{ post.stance }}</span>
                        <span class="post-date">{{ post.date }}</span>
                        <span class="post-status status-{{ post.moderation_status }}">
                            {% if post.moderation_status == "approved" %}‚úì Published{% endif %}
                            {% if post.moderation_status == "pending_review" %}‚è≥ Pending Review{% endif %}
                            {% if post.moderation_status == "rejected" %}‚úó Rejected{% endif %}
                        </span>
                    </div>
                </div>
                <div class="post-content">
                    {{ post.content }}
                </div>
                <div class="post-stats">
                    <span class="stat">‚ñ≤ {{ post.upvotes }}</span>
                    <span class="stat">‚ñº {{ post.downvotes }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</main>

<script>
    document.querySelectorAll('input[name="location_type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const pincodeSection = document.getElementById('pincode-section');
            const constituencySection = document.getElementById('constituency-section');
            
            if (this.value === 'pincode') {
                pincodeSection.classList.remove('hidden');
                constituencySection.classList.add('hidden');
            } else {
                pincodeSection.classList.add('hidden');
                constituencySection.classList.remove('hidden');
            }
        });
    });
</script>
{% endblock %}
